rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user email is in authorized list
    function isAuthorizedUser() {
      return request.auth != null && 
             request.auth.token.email in [
               'salshahrani173@moh.gov.sa',
               'amemahmoud@mog.gov.sa', 
               'rowa.ali.omer@gmail.com',
               'aaldawsari23@moh.gov.sa',
               'atante@moh.gov.sa',
               'yalbishe@moh.gov.sa',
               'relbarahamtoshy@moh.gov.sa',
               'zdalamri@outlook.sa',
               'handaa@mog.gov.sa',
               'nalqahtani112@moh.gov.sa',
               'hamad1234nmnm@moh.gov.sa',
               'thamralshhrany188@gmail.com',
               'salsahrani@moh.gov.sa',
               'fahhadms10@gmail.com',
               'halmanfi@moh.gov.sa'
             ];
    }
    
    // Patients collection - read/write for authorized users
    match /patients/{patientId} {
      allow read, write: if isAuthorizedUser();
    }
    
    // Visits collection - read/write for authorized users
    match /visits/{visitId} {
      allow read, write: if isAuthorizedUser();
    }
    
    // Assessments collection - read/write for authorized users
    match /assessments/{assessmentId} {
      allow read, write: if isAuthorizedUser();
    }
    
    // PDFs collection - read/write for authorized users
    match /pdfs/{pdfId} {
      allow read, write: if isAuthorizedUser();
    }
    
    // Activity log - write only, read for managers
    match /activityLog/{logId} {
      allow write: if isAuthorizedUser();
      allow read: if isAuthorizedUser() && 
                     (request.auth.token.email in [
                       'salshahrani173@moh.gov.sa',
                       'amemahmoud@mog.gov.sa'
                     ]);
    }
    
    // User settings - users can only read/write their own settings
    match /userSettings/{userId} {
      allow read, write: if isAuthenticated() && 
                            request.auth.uid == userId;
    }
    
    // System settings - read only for authorized users, write for managers
    match /systemSettings/{settingId} {
      allow read: if isAuthorizedUser();
      allow write: if isAuthorizedUser() && 
                      request.auth.token.email == 'salshahrani173@moh.gov.sa';
    }
  }
}